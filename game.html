<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EIXO: A Guerra das Mem√≥rias ‚Äî Em Andamento</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/style.css">
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Efeitos visuais -->
    <div id="particles-js"></div>
    <div class="scanlines"></div>
    
    <!-- Header do Jogo -->
    <header class="eixo-header">
        <div class="header-content">
            <div class="logo" onclick="loadScene('prologo')" style="cursor: pointer;">
                <div class="logo-icon"></div>
                <div class="logo-text">
                    <h1 class="glitch" data-text="EIXO">EIXO</h1>
                    <p class="subtitle">A Guerra das Mem√≥rias</p>
                </div>
            </div>
            
            <div class="game-info">
                <div class="info-item">
                    <i class="fas fa-user-secret"></i>
                    <span id="playerName">Carregando...</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-clock"></i>
                    <span id="gameTime">02:37</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-save"></i>
                    <span id="saveStatus">Auto-save: ON</span>
                </div>
                <button onclick="logout()" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i> SAIR
                </button>
            </div>
        </div>
    </header>
    
    <!-- Container do Jogo -->
    <main class="container">
        <div id="game-content" class="game-content">
            <!-- Conte√∫do ser√° carregado aqui -->
            <div class="loading-screen">
                <div class="spinner"></div>
                <p>Inicializando Protocolo E-317...</p>
                <div class="terminal">
                    <div class="terminal-line">> Verificando credenciais do agente...</div>
                    <div class="terminal-line">> Carregando m√≥dulos do sistema...</div>
                    <div class="terminal-line">> Acessando mem√≥rias arquivadas...</div>
                    <div class="terminal-line" id="loadStatus">> Aguarde...</div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer do Jogo -->
    <footer class="eixo-footer">
        <div class="footer-content">
            <div class="status-indicators">
                <div class="indicator">
                    <span class="indicator-label">CONEX√ÉO COM EIXO</span>
                    <div class="indicator-bar">
                        <div class="indicator-fill" style="width: 100%;"></div>
                    </div>
                </div>
            </div>
            <p class="warning">‚ö†Ô∏è Sistema de auto-save ativo | Todas as a√ß√µes s√£o registradas</p>
            <div class="version">Protocolo E-317 | Vers√£o 1.0</div>
        </div>
    </footer>
    
    <!-- Scripts principais -->
    <script src="firebase-config.js"></script>
    <script>
        // Configurar part√≠culas
        particlesJS('particles-js', {
            particles: {
                number: { value: 60, density: { enable: true, value_area: 800 } },
                color: { value: "#00ff9d" },
                shape: { type: "circle" },
                opacity: { value: 0.2, random: true },
                size: { value: 2, random: true },
                line_linked: {
                    enable: true,
                    distance: 120,
                    color: "#9d00ff",
                    opacity: 0.1,
                    width: 1
                },
                move: {
                    enable: true,
                    speed: 1.5,
                    direction: "none",
                    random: true,
                    straight: false,
                    out_mode: "out",
                    bounce: false
                }
            }
        });
        
        // Estado global do jogo
        const gameState = {
            currentScene: 'prologo',
            playerName: 'Agente',
            player: null,
            hora: '02:37',
            dia: 1,
            estabilidadeEixo: 7,
            conscienciaPublica: 2,
            influenciaYango: 1,
            integridadeMoral: 0,
            escolhas: []
        };
        
        // Cache para as cenas carregadas
        let scenesCache = {};
        
        // ============================================
        // FUN√á√ïES PRINCIPAIS CORRIGIDAS
        // ============================================
        
        // Fun√ß√£o para mostrar notifica√ß√£o
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icon = type === 'success' ? 'check' : 
                         type === 'error' ? 'times' : 
                         type === 'warning' ? 'exclamation' : 'info';
            
            notification.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
        // Verificar autentica√ß√£o
        firebase.auth().onAuthStateChanged(async (user) => {
            const loadStatus = document.getElementById('loadStatus');
            
            if (user) {
                gameState.player = user;
                if (loadStatus) {
                    loadStatus.textContent = "> Agente autenticado: " + user.email;
                }
                
                const displayName = user.email.split('@')[0];
                document.getElementById('playerName').textContent = displayName;
                gameState.playerName = displayName;
                
                // Carregar dados do usu√°rio
                try {
                    const userDoc = await firebase.firestore().collection('agentes').doc(user.uid).get();
                    if (userDoc.exists) {
                        const data = userDoc.data();
                        if (data.username) {
                            document.getElementById('playerName').textContent = data.username;
                            gameState.playerName = data.username;
                        }
                    }
                } catch (error) {
                    console.error("Erro ao carregar dados:", error);
                }
                
                // Carregar save do jogador
                await loadPlayerSave();
                
                // Iniciar auto-save
                startAutoSave();
                
                // Carregar primeira cena
                setTimeout(() => {
                    loadScene(gameState.currentScene);
                }, 1000);
                
            } else {
                if (loadStatus) {
                    loadStatus.textContent = "> Nenhuma sess√£o ativa. Redirecionando...";
                }
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }
        });
        
        // Carregar save do jogador
        async function loadPlayerSave() {
            const user = firebase.auth().currentUser;
            if (!user) return;
            
            try {
                const db = firebase.firestore();
                const saveDoc = await db.collection('saves').doc(user.uid).get();
                
                if (saveDoc.exists) {
                    const data = saveDoc.data();
                    console.log("‚úÖ Save carregado");
                    
                    if (data.ultimaCena) {
                        gameState.currentScene = data.ultimaCena;
                    }
                    if (data.estadoJogo) {
                        Object.assign(gameState, data.estadoJogo);
                    }
                    
                    showNotification('Mem√≥ria restaurada do Eixo', 'success');
                } else {
                    console.log("‚ö†Ô∏è Nenhum save encontrado");
                }
            } catch (error) {
                console.error("‚ùå Erro ao carregar save:", error);
            }
        }
        
        // ============================================
        // SISTEMA DE CENAS PRINCIPAL - CORRIGIDO
        // ============================================
        
        async function loadScene(sceneName) {
            console.log("üîÑ Carregando cena:", sceneName);
            
            const container = document.getElementById('game-content');
            
            if (!container) {
                console.error("‚ùå Container n√£o encontrado!");
                return;
            }
            
            try {
                // Atualizar estado
                gameState.currentScene = sceneName;
                
                // Salvar progresso
                await saveProgress();
                
                let sceneContent = '';
                
                // VERIFICAR DE ONDE PEGAR O CONTE√öDO
                if (sceneName === 'prologo') {
                    sceneContent = getPrologoContent();
                } 
                else if (sceneName.startsWith('ato1_')) {
                    // Carregar dinamicamente do ato1.js
                    sceneContent = await loadAto1Scene(sceneName);
                }
                else if (sceneName.startsWith('final_')) {
                    sceneContent = getFinalContent(sceneName);
                }
                else {
                    // Fallback para pr√≥logo
                    sceneContent = getPrologoContent();
                }
                
                // Aplicar nome do jogador
                if (sceneContent) {
                    sceneContent = sceneContent.replace(/\[NOME_DO_JOGADOR\]/g, gameState.playerName);
                }
                
                // Atualizar container
                container.innerHTML = sceneContent;
                
                // Scroll para topo
                window.scrollTo(0, 0);
                
                console.log("‚úÖ Cena renderizada:", sceneName);
                
            } catch (error) {
                console.error("‚ùå Erro ao carregar cena:", error);
                container.innerHTML = `
                    <div class="error-screen">
                        <h2><i class="fas fa-exclamation-triangle"></i> ERRO DO SISTEMA</h2>
                        <p>Falha ao carregar a cena ${sceneName}.</p>
                        <p><small>${error.message}</small></p>
                        <button onclick="loadScene('prologo')" class="btn btn-secondary">
                            <i class="fas fa-redo"></i> VOLTAR AO IN√çCIO
                        </button>
                    </div>
                `;
            }
        }
        
        // Fun√ß√£o corrigida para carregar cenas do ato1.js
        async function loadAto1Scene(sceneName) {
            console.log("üì• Tentando carregar:", sceneName);
            
            // Se j√° temos no cache, usar do cache
            if (scenesCache[sceneName]) {
                console.log("üìÇ Usando cena do cache:", sceneName);
                return scenesCache[sceneName];
            }
            
            try {
                // Carregar dinamicamente o m√≥dulo
                console.log("üì• Carregando m√≥dulo ato1.js...");
                
                // Tente diferentes caminhos
                let module;
                try {
                    module = await import('./scenes/ato1.js');
                } catch (importError) {
                    console.error("‚ùå Erro ao importar:", importError);
                    // Tenta caminho alternativo
                    module = await import('/scenes/ato1.js');
                }
                
                // Verificar se a cena existe no m√≥dulo
                if (module && module[sceneName] && module[sceneName].text) {
                    scenesCache[sceneName] = module[sceneName].text;
                    console.log("‚úÖ Cena carregada:", sceneName);
                    return module[sceneName].text;
                } else {
                    console.error("‚ùå Cena n√£o encontrada no m√≥dulo:", sceneName);
                    console.log("üì¶ M√≥dulo carregado:", Object.keys(module || {}));
                    throw new Error(`Cena ${sceneName} n√£o encontrada no ato1.js`);
                }
            } catch (error) {
                console.error("‚ùå Erro ao carregar cena espec√≠fica:", error);
                
                // Fallback: mostrar conte√∫do de fallback
                return `
                    <div class="scene">
                        <div class="narrador">
                            <h2>ERRO TEMPOR√ÅRIO</h2>
                            <p>O sistema est√° enfrentando problemas para carregar a cena ${sceneName}.</p>
                            <p>Por favor, tente novamente ou volte ao in√≠cio.</p>
                            <button onclick="loadScene('prologo')" class="btn btn-primary">
                                <i class="fas fa-home"></i> VOLTAR AO IN√çCIO
                            </button>
                            <button onclick="debugCenas()" class="btn btn-secondary" style="margin-left: 10px;">
                                <i class="fas fa-bug"></i> DEBUG
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        // Fun√ß√£o de debug
        function debugCenas() {
            console.log("üîç Debug - Estado do jogo:", gameState);
            console.log("üîç Debug - Cenas em cache:", Object.keys(scenesCache));
            console.log("üîç Debug - Usu√°rio:", firebase.auth().currentUser);
            alert("Debug: Veja o console (F12) para mais informa√ß√µes.");
        }
        
        // ============================================
        // CONTE√öDO DAS CENAS LOCAIS
        // ============================================
        
        function getPrologoContent() {
            return `
                <div class="scene prologo">
                    <div class="narrador">
                        <h1>EIXO: A Guerra das Mem√≥rias</h1>
                        
                        <div class="text-block">
                            <p>Bras√≠lia n√£o nasceu apenas de concreto.</p>
                            <p>Entre eixos, asas e monumentos, ergueu-se tamb√©m algo invis√≠vel:<br>
                            uma m√°quina paciente, feita de decis√µes, omiss√µes e mem√≥rias arquivadas.</p>
                            
                            <p class="destaque">Alguns a chamam de governo.<br>
                            Outros, de sistema.<br>
                            Nos documentos mais antigos, por√©m, ela recebe outro nome: <strong>Eixo</strong>.</p>
                            
                            <p>O Eixo n√£o tem rosto.<br>
                            Ele usa rostos.</p>
                            
                            <p>E, quando a verdade √© distorcida vezes demais,<br>
                            a pr√≥pria realidade come√ßa a falhar.</p>
                            
                            <p class="destaque-personagem">√â aqui que voc√™ entra, <span class="player-name">${gameState.playerName}</span>.<br>
                            Em um escrit√≥rio qualquer, em uma madrugada qualquer,<br>
                            prestes a abrir um arquivo que n√£o deveria existir.</p>
                        </div>
                        
                        <button onclick="loadScene('ato1_cena1')" class="btn btn-primary">
                            <i class="fas fa-play"></i> INICIAR JORNADA
                        </button>
                    </div>
                </div>
            `;
        }
        
        function getFinalContent(finalType) {
            const finais = {
                'final_a': {
                    titulo: 'O APAGAMENTO',
                    descricao: 'Voc√™ apagou o documento. O Eixo agradece sua coopera√ß√£o.',
                    consequencias: '+2 Estabilidade do Eixo, -1 Integridade Moral'
                },
                'final_b': {
                    titulo: 'O DENUNCIANTE', 
                    descricao: 'Voc√™ denunciou a anomalia. Agora o sistema sabe que voc√™ sabe.',
                    consequencias: '+1 Consci√™ncia P√∫blica, -2 Estabilidade do Eixo'
                },
                'final_c': {
                    titulo: 'O INVESTIGADOR',
                    descricao: 'Voc√™ come√ßou a investigar Yango. A anomalia sabe que voc√™ est√° procurando.',
                    consequencias: '+2 Influ√™ncia de Yango, +1 Integridade Moral'
                }
            };
            
            const final = finais[finalType] || finais.final_a;
            
            return `
                <div class="scene final">
                    <div class="narrador">
                        <h2>FIM DO ATO I ‚Äî ${final.titulo}</h2>
                        
                        <div class="text-block">
                            <p>${final.descricao}</p>
                            
                            <div class="tela sistema">
                                <div class="tela-conteudo">
                                    <h3>RELAT√ìRIO DE CONSEQU√äNCIAS</h3>
                                    <p>${final.consequencias}</p>
                                    <p>Estado atual:</p>
                                    <ul>
                                        <li>Estabilidade do Eixo: ${gameState.estabilidadeEixo}/10</li>
                                        <li>Consci√™ncia P√∫blica: ${gameState.conscienciaPublica}/10</li>
                                        <li>Influ√™ncia de Yango: ${gameState.influenciaYango}/10</li>
                                        <li>Sua Integridade Moral: ${gameState.integridadeMoral}/5</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <p class="destaque">O Eixo observa. Suas a√ß√µes ser√£o lembradas.</p>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <button onclick="loadScene('prologo')" class="btn btn-primary">
                                <i class="fas fa-redo"></i> JOGAR NOVAMENTE
                            </button>
                            <button onclick="salvarEVoltar()" class="btn btn-secondary" style="margin-left: 10px;">
                                <i class="fas fa-home"></i> SALVAR E SAIR
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ============================================
        // PROCESSAMENTO DE ESCOLHAS
        // ============================================
        
        function processarEscolha(opcao) {
            console.log("üéØ Processando escolha:", opcao);
            showNotification(`Op√ß√£o ${opcao} registrada`, 'info');
            
            // Aplicar consequ√™ncias
            switch(opcao) {
                case 'A':
                    gameState.estabilidadeEixo += 2;
                    gameState.integridadeMoral -= 1;
                    gameState.escolhas.push('A');
                    showNotification('Documento apagado. O Eixo agradece.', 'success');
                    setTimeout(() => {
                        saveProgress();
                        loadScene('final_a');
                    }, 1000);
                    break;
                    
                case 'B':
                    gameState.conscienciaPublica += 1;
                    gameState.estabilidadeEixo -= 2;
                    gameState.escolhas.push('B');
                    showNotification('Den√∫ncia registrada. O sistema est√° ciente.', 'warning');
                    setTimeout(() => {
                        saveProgress();
                        loadScene('final_b');
                    }, 1000);
                    break;
                    
                case 'C':
                    gameState.influenciaYango += 2;
                    gameState.integridadeMoral += 1;
                    gameState.escolhas.push('C');
                    showNotification('Investiga√ß√£o iniciada. Yango sabe que voc√™ o procura.', 'info');
                    setTimeout(() => {
                        saveProgress();
                        loadScene('final_c');
                    }, 1000);
                    break;
            }
        }
        
        // ============================================
        // SISTEMA DE SALVAMENTO
        // ============================================
        
        async function saveProgress() {
            const user = firebase.auth().currentUser;
            if (!user) return false;
            
            try {
                const db = firebase.firestore();
                await db.collection('saves').doc(user.uid).set({
                    estadoJogo: {
                        currentScene: gameState.currentScene,
                        playerName: gameState.playerName,
                        hora: gameState.hora,
                        dia: gameState.dia,
                        estabilidadeEixo: gameState.estabilidadeEixo,
                        conscienciaPublica: gameState.conscienciaPublica,
                        influenciaYango: gameState.influenciaYango,
                        integridadeMoral: gameState.integridadeMoral,
                        escolhas: gameState.escolhas
                    },
                    jogador: {
                        nome: gameState.playerName,
                        email: user.email
                    },
                    salvoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    ultimaCena: gameState.currentScene
                });
                
                console.log("üíæ Progresso salvo");
                return true;
            } catch (error) {
                console.error("‚ùå Erro ao salvar:", error);
                return false;
            }
        }
        
        // Auto-save
        function startAutoSave(intervalMinutes = 3) {
            setInterval(() => {
                if (firebase.auth().currentUser) {
                    saveProgress();
                }
            }, intervalMinutes * 60 * 1000);
        }
        
        // ============================================
        // FUN√á√ïES GLOBAIS
        // ============================================
        
        // Tornar as fun√ß√µes globais
        window.loadScene = loadScene;
        window.avancarCena = function(cenaId) {
            loadScene(cenaId);
        };
        window.escolherOpcao = function(opcao) {
            processarEscolha(opcao);
        };
        window.debugCenas = debugCenas;
        
        window.salvarEVoltar = async function() {
            await saveProgress();
            window.location.href = 'index.html';
        };
        
        window.logout = async function() {
            try {
                await saveProgress();
                await firebase.auth().signOut();
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Erro ao sair:", error);
                showNotification('Erro ao sair do sistema', 'error');
            }
        };
        
        // Salvar antes de sair da p√°gina
        window.addEventListener('beforeunload', async (e) => {
            if (firebase.auth().currentUser) {
                await saveProgress();
            }
        });
        
        // Debug helper
        window.debugState = function() {
            console.log("üîç Estado do jogo:", gameState);
            console.log("üìÇ Cenas em cache:", Object.keys(scenesCache));
        };
        
    </script>
</body>
</html>